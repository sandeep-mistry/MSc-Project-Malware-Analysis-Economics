import numpy as np
from common import *
from grebber import chunks
from multiprocessing import Process
from scipy.stats import entropy
import reader as r
from progressbar import Percentage, Bar, ProgressBar, ETA
import sys
import time
import os.path
import pickle


def byteEntropy(byteFreq):
    probs = np.array(byteFreq)
    probs = probs / probs.sum()
    ent = entropy(probs)
    return ent


def findIndex(lst):
    res = 0
    for idx, val in enumerate(lst):
        res += val * (257 ** idx)
    return res


def byteSeqToInt(seq):
    bytes = []
    for row in seq:
        for item in row.split(' ')[1:]:
            if item != "??":
                bytes.append(int(item, 16))
            else:
                bytes.append(256)
    return bytes


def processFile(text):
    bytes = byteSeqToInt(text)

    if __name__ == "__main__":

        if sys.argv[1] == "1gram":
            # 1gram
            byte1gram = [0] * 257
            for item in bytes:
                byte1gram[item] += 1
            res = {'1g': byte1gram}

        elif sys.argv[1] == "2gram":
            # 2gram
            n = 2
            byte2gram = {}
            for i in range(len(bytes)-n+1):
                idx = findIndex(bytes[i:i+n])
                byte2gram[idx] = byte2gram.get(idx, 0) + 1
            res = {'2g': byte2gram}

        elif sys.argv[1] == "3gram":
            # 3gram
            n = 3
            byte3gram = {}
            for i in range(len(bytes)-n+1):
                idx = findIndex(bytes[i:i+n])
                byte3gram[idx] = byte3gram.get(idx, 0) + 1
            res = {'3g': byte3gram}

        else:
            print("Invalid entry")
            exit()

    return res

def worker(chunk, output_dir):
    widgets = ['Worker {}: '.format(chunk[0]), ' ', Percentage(), ' ', Bar(), ' ', ETA()]
    pbar = ProgressBar(widgets=widgets, maxval=len(chunk[1])).start()
    for idx, item in enumerate(chunk[1]):
        fn = item.split(os.sep)[-1].split(".")[0]

        # Save data
        data = processFile(r.readBytes(item))
        pickle.dump(data, open(os.path.join(output_dir, fn), "wb"))

        # Update progressbar
        pbar.update(idx + 1)
    pbar.finish()


if __name__ == "__main__":
    while True:
        try:
            numWorkers = int(sys.argv[2])
            break
        except ValueError:
            print("That was not a valid number.  Try again...")
    split_data = chunks(dataset, numWorkers)
    output_dir = byte_feat_dir
    clearPath(output_dir)

jobs = []
start_time = time.time()

print("Byte feature extraction started!")
for item in enumerate(split_data):
    p = Process(target=worker, args=(item, output_dir))
    jobs.append(p)
    p.start()

for j in jobs:
    j.join()

print("Byte feature extraction completed!")

if __name__ == "__main__":

    if sys.argv[1] == "1gram":
        extraction_time_1g = time.time() - start_time
        extraction_time_export('1_gram.dat', extraction_time_1g)

    elif sys.argv[1] == "2gram":
        extraction_time_2g = time.time() - start_time
        extraction_time_export('2_gram.dat', extraction_time_2g)

    elif sys.argv[1] == "3gram":
        extraction_time_3g = time.time() - start_time
        extraction_time_export('3_gram.dat', extraction_time_3g)

    else:
        print("Invalid argument! Enter '1gram', '2gram' or '3gram'.")
        exit()
