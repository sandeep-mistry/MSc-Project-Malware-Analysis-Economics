import hashlib
import os
import csv


# MD5 calculation function

def md5sum(filename):
    md5 = hashlib.md5()
    with open(filename, 'rb') as f:
        for chunk in iter(lambda: f.read(128 * md5.block_size), b''):
            md5.update(chunk)
    return md5.hexdigest()


rootdir = "/media/sandeep/DATA/raw_final_dataset/RAW_final_dataset/"
output = "/media/sandeep/DATA/raw_final_dataset/Labels.csv"
subdirectories = {"unclassified": 0, "Adware": 1, "Backdoor": 2, "Generic": 3, "Trojan": 4, "Virus": 5, "Worm": 6}

count = 0
csv_file = open(output, mode="w")

writer = csv.writer(csv_file, delimiter=',')
writer.writerow(["MD5hash", "ClassLabel"])

# for subdir, dirs, files in os.walk(rootdir):
#     for file in files:
for subdirectory, class_label in subdirectories.items():
    new_directory = os.path.join(rootdir, subdirectory)
    for root, dirs, files in os.walk(new_directory):
        for file in files:
            try:
                fileHash = md5sum(new_directory + '/' + file)
            except Exception as e:
                print("Error while calculating MD5 for the file", file)
            else:
                try:
                    print("Writing file number", count)
                    writer.writerow([fileHash, class_label])
                    count += 1
                except Exception as e:
                    print("Error writing to csv", e)

csv_file.close()
